{% extends "mantenedores/paginaBase.html" %}
{% load static %}

{% block titulo %}
<h1 class="text-center p-3 rounded">Listado de Proveedores</h1>
{% endblock titulo %}

{% block contenido %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<div class="container mt-3">

  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
    <div class="d-flex gap-2">
      <a href="{% url 'proveedores:agregar' %}" class="btn btn-success">
        + Agregar Proveedor
      </a>

      <a href="{% url 'proveedores:exportar' %}?q={{ q|urlencode }}" class="btn btn-outline-success">
        Exportar a Excel
      </a>
    </div>

    <div class="d-flex gap-2">
      <select id="perPage" class="form-select form-select-sm">
        <option value="10" {% if per_page|add:'0' == 10 %}selected{% endif %}>10</option>
        <option value="15" {% if per_page|add:'0' == 15 %}selected{% endif %}>15</option>
        <option value="25" {% if per_page|add:'0' == 25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page|add:'0' == 50 %}selected{% endif %}>50</option>
      </select>

      <div class="input-group">
        <input id="searchBox" type="text" class="form-control" placeholder="Buscar por razón social, RUT, email, ciudad"
               value="{{ q }}">
        <button id="btnBuscar" class="btn btn-danger">Buscar</button>
      </div>
    </div>
  </div>

  {% if page_obj.object_list %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover table-striped align-middle">
      <thead class="text-white" style="background-color: #990000;">
        <tr>
          <th>#</th>
          <th>Razón Social</th>
          <th>RUT/NIF</th>
          <th>Email</th>
          <th>Teléfono</th>
          <th>Ciudad</th>
          <th>Región</th>
          <th>Estado</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaProveedores">
        {% for p in page_obj %}
        <tr>
          <td class="text-center">{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td>{{ p.razon_social }}</td>
          <td>{{ p.rut_nif }}</td>
          <td>{{ p.email }}</td>
          <td>{{ p.telefono }}</td>
          <td>{{ p.ciudad }}</td>
          <td>{% if p.region %}{{ p.region.nombre }}{% endif %}</td>
          <td>
            {% if p.estado == "ACTIVO" %}
              <span class="badge bg-success">Activo</span>
            {% else %}
              <span class="badge bg-secondary">Bloqueado</span>
            {% endif %}
          </td>
          <td class="text-center">
            <a href="{% url 'proveedores:editar' p.id %}" class="btn btn-warning btn-sm me-1">Editar</a>
            <button class="btn btn-danger btn-sm btnEliminar" data-id="{{ p.id }}">Eliminar</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <nav aria-label="Paginación" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?q={{ q|urlencode }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Anterior</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item"><a class="page-link" href="?q={{ q|urlencode }}&per_page={{ per_page }}&page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?q={{ q|urlencode }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Siguiente</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
      {% endif %}
    </ul>
  </nav>

  {% else %}
    <div class="alert alert-warning text-center">No hay proveedores registrados.</div>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function goList(params = {}) {
    const url = new URL(window.location.href);
    if (params.q !== undefined) url.searchParams.set("q", params.q);
    if (params.per_page !== undefined) url.searchParams.set("per_page", params.per_page);
    url.searchParams.delete("page"); 
    window.location.href = url.toString();
  }

  const searchBox = document.getElementById("searchBox");
  const btnBuscar = document.getElementById("btnBuscar");
  const perPage = document.getElementById("perPage");

  let t;
  searchBox.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(() => {
      goList({ q: searchBox.value, per_page: perPage.value });
    }, 350);
  });

  btnBuscar.addEventListener("click", () => {
    goList({ q: searchBox.value, per_page: perPage.value });
  });

  perPage.addEventListener("change", () => {
    goList({ q: searchBox.value, per_page: perPage.value });
  });

  document.querySelectorAll(".btnEliminar").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;

      Swal.fire({
        title: '¿Eliminar proveedor?',
        text: 'Esta acción no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`{% url 'proveedores:eliminar' 0 %}`.replace("0", id), {
            method: "POST",
            headers: {
              "X-CSRFToken": csrftoken,
              "X-Requested-With": "XMLHttpRequest",
            },
          })
          .then(r => r.json())
          .then(data => {
            if (data.ok) {
              Swal.fire('Eliminado', 'El proveedor ha sido eliminado.', 'success')
                .then(() => window.location.reload());
            } else {
              Swal.fire('Error', 'No se pudo eliminar.', 'error');
            }
          })
          .catch(() => Swal.fire('Error', 'No se pudo eliminar.', 'error'));
        }
      });
    });
  });
</script>

{% endblock contenido %}
