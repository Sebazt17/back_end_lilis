{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Nueva contraseña</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
body {
    background: linear-gradient(rgba(178,34,34,0.85), rgba(178,34,34,0.85)),
                url("{% static 'images/hero.jpg' %}") center/cover no-repeat fixed;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}
.card-reset {
    background: #fff;
    padding: 2.5rem;
    border-radius: 20px;
    border: 2px solid #ffeaea;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.22);
    animation: fadeSlide .6s ease-out;
}
@keyframes fadeSlide { from {opacity:0; transform: translateY(50px);} to{opacity:1; transform: translateY(0);} }

.input-group {
    position: relative;
}
.toggle-pass {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 1.2rem;
    color: #b22222;
}
.form-control:focus {
    border-color: #b22222 !important;
    box-shadow: 0 0 0 .2rem rgba(178,34,34,.25) !important;
}
.btn-primary {
    background-color: #b22222;
    border-color: #b22222;
}
.btn-primary:hover {
    background-color: #9a1c1c;
    border-color: #9a1c1c;
}
#strengthBar {
    height: 6px;
    width: 100%;
    background: #ddd;
    border-radius: 20px;
    margin-top: 5px;
    transition: width .3s ease;
}

#strengthMsg {
    display: block;
    min-height: 18px; 
    margin-bottom: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    color: #b22222;
}

#matchMsg {
    display: block;
    min-height: 18px;
    margin-bottom: 2px;
    font-size: 0.85rem;
    color: #b22222;
}

#btnSubmit:disabled {
    background-color: #d38a8a !important;
    border-color: #d38a8a !important;
    cursor: not-allowed;
    opacity: 1 !important;
}

</style>
</head>

<body>

<div class="card-reset">
    <h2 class="fw-bold text-center" style="color:#b22222;">NUEVA CONTRASEÑA</h2>

    <form method="post">
        {% csrf_token %}

        <label class="mt-3">Nueva contraseña</label>
        <div class="input-group">
            {{ form.new_password1 }}
            <i class="bi bi-eye-slash toggle-pass" onclick="togglePassword('id_new_password1', this)"></i>
        </div>

        <div id="strengthBar"></div>
        <small id="strengthMsg" class="text-error"></small>

        {% if form.new_password1.errors %}
            <div class="alert alert-danger py-1 mt-1">{{ form.new_password1.errors.0 }}</div>
        {% endif %}

        <label class="mt-3">Confirmar contraseña</label>
        <div class="input-group">
            {{ form.new_password2 }}
            <i class="bi bi-eye-slash toggle-pass" onclick="togglePassword('id_new_password2', this)"></i>
        </div>
        <small id="matchMsg" class="text-error"></small>

        {% if form.new_password2.errors %}
            <div class="alert alert-danger py-1 mt-1">{{ form.new_password2.errors.0 }}</div>
        {% endif %}

        <button id="btnSubmit" type="submit" class="btn btn-primary w-100 mt-4" disabled>
            Cambiar contraseña
        </button>
    </form>

    <div class="text-center mt-3">
        <a href="{% url 'accounts_lilis:password_reset' %}" style="color:#b22222;">
            ← Volver a recuperar
        </a>
    </div>
</div>

<script>
function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);

    if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("bi-eye-slash");
        icon.classList.add("bi-eye");
    } else {
        input.type = "password";
        icon.classList.remove("bi-eye");
        icon.classList.add("bi-eye-slash");
    }
}

const password1 = document.getElementById("id_new_password1");
const password2 = document.getElementById("id_new_password2");
const bar = document.getElementById("strengthBar");
const msg = document.getElementById("strengthMsg");
const matchMsg = document.getElementById("matchMsg");
const btnSubmit = document.getElementById("btnSubmit");

password1.addEventListener("input", checkStrength);
password2.addEventListener("input", checkMatch);

function checkStrength() {
    const pwd = password1.value;
    let strength = 0;

    if (pwd.length >= 8) strength++;
    if (/[A-Z]/.test(pwd)) strength++;
    if (/[0-9]/.test(pwd)) strength++;
    if (/[^A-Za-z0-9]/.test(pwd)) strength++;

    const widths = ["10%", "40%", "70%", "100%"];
    const colors = ["#b22222", "#c9781c", "#f0db4f", "#2ecc71"];
    const texts = ["Muy débil", "Débil", "Buena", "Fuerte"];

    bar.style.width = widths[strength - 1] || "0";
    bar.style.background = colors[strength - 1] || "#ddd";
    msg.innerText = texts[strength - 1] || "";

    checkMatch();
}

function checkMatch() {
    if (password1.value && password2.value && password1.value !== password2.value) {
        matchMsg.innerText = "Las contraseñas no coinciden.";
        btnSubmit.disabled = true;
    } else {
        matchMsg.innerText = "";
        if (msg.innerText === "Buena" || msg.innerText === "Fuerte") {
            btnSubmit.disabled = false;
        }
    }
}
</script>

</body>
</html>
